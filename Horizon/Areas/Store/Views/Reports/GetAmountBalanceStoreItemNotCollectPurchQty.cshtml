@model AmountNotCollectReportContainer
@{
    var title = "ارصدة المنتجات مع سعر الصاج";
    ViewData["Title"] = title;
    string data = JsonConvert.SerializeObject(Model.Items);
}

<div id="app" class="container mx-auto px-4 py-6">
    <!-- Card Header -->
    <div class="flex justify-between items-center mb-8 mt-4">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="#000000" stroke-width="2" class="stroke-[#212b36]" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="M14.8 9a2 2 0 0 0 -1.8 -1h-2a2 2 0 1 0 0 4h2a2 2 0 1 1 0 4h-2a2 2 0 0 1 -1.8 -1" />
                <path d="M12 7v10" />
            </svg>
            <h1 class="text-2xl text-[#212b36] font-bold">{{ title }}</h1>
        </div>
    </div>

    <!-- Error Alert -->
    <div v-if="errorMessage" class="bg-red-100 fade border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <span>{{ errorMessage }}</span>
        </div>
    </div>

    <!-- Search Form Card -->
    <div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
        <div class="bg-primary text-white px-6 py-4 flex items-center gap-2">
            <i class="fas fa-search"></i>
            <h2 class="text-lg font-semibold">بحث في أرصدة المنتجات</h2>
        </div>
        <div class="p-6">
            <form asp-controller="Reports" asp-action="GetAmountBalanceStoreItemNotCollectPurchQty" method="post" class="space-y-4">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        @Html.Editor("StoreItemId","StoreItemsList",new
                        {
                            htmlAttributes = new
                            {
                                @name = "StoreItemId",
                                @id = "StoreItemId",
                                @class = "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            }
                        })
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ البداية</label>
                            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   value="@Model.Search.StartDate" name="StartDate" id="StartDate" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ النهاية</label>
                            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   value="@Model.Search.EndDate" name="EndDate" id="EndDate" required />
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit"
                            class="bg-emerald-800 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg w-full md:w-1/4 mx-auto transition-colors">
                            بحث
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Card -->
    <div v-if="items.length > 0" class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
        <data-table :columns="columns" :data="items" :searchable="true" :sortable="true" :paginated="true"
            :per-page-options="[10, 25, 50, 100]" :default-per-page="25" search-placeholder="البحث في أرصدة المنتجات مع سعر الصاج..."
            no-data-message="لا توجد بيانات متاحة" @@row-action="handleRowAction" @@row-click="handleRowClick"
            @@sort-change="handleSortChange" @@page-change="handlePageChange"
            ref="priceBalanceTable">

            <!-- Summary Slot -->
            <template #summary>
                <div class="bg-gray-50 px-4 py-3 flex justify-between items-center border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        إجمالي العناصر: <span class="font-medium">{{ totalItems }}</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        النتائج المعروضة: <span class="font-medium">{{ searchResults }}</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        إجمالي قيمة المخزون: <span class="font-medium">{{ totalValue }}</span>
                    </div>
                </div>
            </template>
        </data-table>
    </div>

    <!-- No Data Message -->
    <div v-else class="bg-white rounded-lg shadow-md p-8 text-center">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">لا توجد بيانات</h3>
        <p class="text-gray-600">استخدم نموذج البحث أعلاه للعثور على أرصدة المنتجات.</p>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- Import the DataTable component -->
    <script type="module">
        import { DataTable } from '/assets/components/DataTable.js?v=2.6';

        const { createApp } = Vue;

        createApp({
            components: {
                DataTable
            },
            data() {
                return {
                    title: 'ارصدة المنتجات مع سعر الصاج',
                    items: @Html.Raw(data),
                    totalItems: 0,
                    searchResults: 0,
                    currentPage: 1,
                    errorMessage: '@Html.Raw(ViewBag.Errors ?? "")',
                    columns: [
                        {
                            key: 'StoreItemName',
                            label: 'المنتج',
                            sortable: true,
                            searchable: true,
                            width: 'w-2/5'
                        },
                        {
                            key: 'StoreItemMainQuantity',
                            label: 'الكمية',
                            sortable: true,
                            align: 'right',
                            width: 'w-1/5',
                            format: (value) => {
                                if (value === null || value === undefined || value === '') return '0';
                                const num = parseFloat(value);
                                return num.toLocaleString('ar-EG');
                            }
                        },
                        {
                            key: 'PriceItemsRawPurchase',
                            label: 'سعر الصاج',
                            sortable: true,
                            align: 'right',
                            width: 'w-2/5',
                            format: (value) => {
                                if (value === null || value === undefined || value === '') return '0.00';
                                const num = parseFloat(value);
                                return num.toLocaleString('ar-EG', { 
                                    minimumFractionDigits: 2, 
                                    maximumFractionDigits: 2 
                                }) + ' ج.م';
                            }
                        }
                    ]
                }
            },
            computed: {
                totalValue() {
                    const total = this.items.reduce((sum, item) => {
                        const quantity = parseFloat(item.StoreItemMainQuantity) || 0;
                        const price = parseFloat(item.PriceItemsRawPurchase) || 0;
                        return sum + (quantity * price);
                    }, 0);
                    return total.toLocaleString('ar-EG', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    }) + ' ج.م';
                }
            },
            mounted() {
                this.totalItems = this.items.length;
                this.searchResults = this.items.length;

                // Set document title
                document.title = this.title;

                // Initialize Select2 if available
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    $("#StoreItemId").select2();
                }
            },
            methods: {
                handleRowAction(event) {
                    const { action, item } = event;

                    switch (action) {
                        case 'details':
                            this.showItemDetails(item);
                            break;
                        case 'history':
                            this.showItemHistory(item);
                            break;
                    }
                },

                showItemDetails(item) {
                    // Implement your detail view logic here
                    console.log('Showing details for:', item);
                    // Example: window.location.href = `/Inventory/Details/${item.Id}`;
                },

                showItemHistory(item) {
                    // Implement history view logic here
                    console.log('Showing history for:', item);
                    // Example: window.location.href = `/Inventory/History/${item.Id}`;
                },

                handleRowClick(item) {
                    console.log('Row clicked:', item);
                    // You can implement row click behavior here
                },

                handleSearchChange(event) {
                    this.searchResults = event.results;
                },

                handleSortChange(event) {
                    console.log('Sort changed:', event);
                },

                handlePageChange(event) {
                    this.currentPage = event.page;
                }
            }
        }).mount('#app');
    </script>
}